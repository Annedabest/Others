generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String             @id @default(uuid())
  name      String
  locale    String             @default("en-CA")
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  budgets   Budget[]
  receipts  Receipt[]
  users     UserOrganization[]
}

model User {
  id            String             @id @default(uuid())
  email         String             @unique
  passwordHash  String
  displayName   String
  language      String             @default("en")
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  receipts      Receipt[]
  organizations UserOrganization[]
}

model UserOrganization {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  role           String
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([userId, organizationId])
}

model Budget {
  id             String           @id @default(uuid())
  organizationId String
  name           String
  currency       String
  periodStart    DateTime
  periodEnd      DateTime
  status         BudgetStatus
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id])
  categories     BudgetCategory[]
}

model BudgetCategory {
  id         String           @id @default(uuid())
  budgetId   String
  parentId   String?
  name       String
  allocation Decimal          @db.Decimal(14, 2)
  spent      Decimal          @default(0) @db.Decimal(14, 2)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  budget     Budget           @relation(fields: [budgetId], references: [id])
  parent     BudgetCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children   BudgetCategory[] @relation("CategoryHierarchy")
}

model Receipt {
  id             String        @id @default(uuid())
  organizationId String
  userId         String?
  vendor         String?
  amount         Decimal       @db.Decimal(14, 2)
  currency       String
  status         ReceiptStatus @default(PENDING)
  source         String
  documentUrl    String?
  receivedAt     DateTime
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id])
  user           User?         @relation(fields: [userId], references: [id])
}

enum BudgetStatus {
  ACTIVE
  ARCHIVED
}

enum ReceiptStatus {
  PENDING
  MATCHED
  APPROVED
  ARCHIVED
}
